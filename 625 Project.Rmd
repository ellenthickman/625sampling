---
title: "625 Sampling Project"
author: "Ellen Hickman, Mi Huynh, Maze Nead & Zupeng Zeng"
date: "2026-01-21"
output:
  word_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
# Load necessary libraries
library(ggplot2)
library(dplyr)
library(readxl)
library(knitr)
library(ggrepel)
library(tidyverse)
options(scipen = 999)
```

## Download data
```{r}
schoolframe <- read.csv("https://raw.githubusercontent.com/ellenthickman/625sampling/refs/heads/main/MI_school_frame_head_counts.csv")
kable(schoolframe)
```

# Sampling Frame Analysis
## 1. Noncoverage
### Examine by: searching current # of MI schools (eg. charter). See: https://www.mischooldata.org/student-enrollment-counts-report/
### Prevalence:
### Solution: Acknowledge and accept in analysis. 

## 2. Blanks: Ellen.
### Examine by: Missingness check. 
``` {r}
# a. Check missingness across variables as blank ""
sapply(schoolframe, function(x) sum(x == "", na.rm = TRUE))
```
Out of 2,443 schools in Michigan, 559 do not have listed District Names. Let's examine this prevalence by Non-Public/Public schools and by Region.

### Prevalence: (eg. Frequency tables)
```{r}
# b. Since missing district name might vary by public/private school status, let's check:
tab1 <- table(schoolframe$District_Name == "", schoolframe$Public.nonpublic); kable(tab1)
# c. By region, let's check:
tab2 <- table(schoolframe$District_Name == "", schoolframe$Region); kable(tab2)
tab3 <- table(factor(schoolframe$District_Name == "", levels = c(TRUE, FALSE)),
             factor(schoolframe$Region))
kable(prop.table(tab3, margin = 2))
# c. By district code, let's check:
tab4 <- table(schoolframe$DCODE, schoolframe$District_Name == ""); kable(tab4)
```
From Tables 1-3, we see that the majority of missing district name cases (547/559, 98%) belong to non-public (ie. private) schools, whereas only a handful of public schools are missing district names (12/1884, ~0.0%). It also looks like even though the private schools are missing District Names, they do belong to a District Code that other, public schools are also a part of. 

### Solution:
So, the solution to the problem is to 1) ignore District Names as a cluster variable, and rely on region or district code if needed. If need be, the district name could be 2) imputed from the dcode variable for reference in communicating the results. 

## 3. Duplicates: Mi. In the whole observation. 
### Examine by: “print unique”
### Prevalence:
### Solution:

## 4. Clustering: Zupeng.
### Examine by: 
### Prevalence:
### Solution:
```{r}
# Basic cleaning: ensure head-count columns are numeric (handles commas if present)
count_vars <- c("g7_totl","g8_totl","g9_totl","g10_totl","g11_totl","g12_totl","tot_all")

schoolframe <- schoolframe %>%
  mutate(across(all_of(count_vars),
                ~ as.numeric(gsub(",", "", as.character(.x)))))

# Sanity checks
N_rows     <- nrow(schoolframe)
N_bcode    <- n_distinct(schoolframe$BCODE)
N_district <- n_distinct(schoolframe$DCODE)

N_rows; N_bcode; N_district

# Check whether BCODE is unique (should be if each row is a unique school/building record)
bcode_dupes <- schoolframe %>%
  count(BCODE) %>%
  filter(n > 1) %>%
  arrange(desc(n))

bcode_dupes

# District-level school clustering
district_summary <- schoolframe %>%
  group_by(DCODE) %>%
  summarise(
    n_schools = n(),
    district_name_count = n_distinct(na.omit(District_Name)),
    total_enroll = sum(tot_all, na.rm = TRUE),
    .groups = "drop"
  )

# Distribution of schools per district
summary(district_summary$n_schools)

qs <- quantile(
  district_summary$n_schools,
  probs = c(.25, .50, .75, .90, .95, .99),
  na.rm = TRUE
)
qs

# Violin Plot
q_df <- tibble(
  prob  = names(qs),
  value = as.numeric(qs)
)

ggplot(district_summary, aes(x = "", y = n_schools)) +
  geom_violin(trim = FALSE) +
  geom_boxplot(width = 0.18, outlier.shape = NA) +
  geom_segment(
    data = q_df,
    aes(x = 0.85, xend = 1.15, y = value, yend = value),
    inherit.aes = FALSE,
    linewidth = 0.6
  ) +
  geom_text_repel(
    data = q_df,
    aes(x = 1.22, y = value, label = paste0(prob, ": ", round(value, 2))),
    inherit.aes = FALSE,
    direction = "y",
    nudge_x = 0.08,
    hjust = 0,
    size = 3,
    min.segment.length = 0
  ) +
  labs(
    title = "Distribution of Number of Schools by District",
    x = NULL,
    y = "Schools per district"
  ) +
  coord_cartesian(clip = "off") +
  theme_minimal() +
  theme(
    plot.margin = margin(5.5, 90, 5.5, 5.5),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()
  )

# Largest districts by number of schools
district_summary %>%
  arrange(desc(n_schools)) %>%
  slice_head(n = 10)

# Potential data issue: DCODE mapping to more than one District_Name
district_summary %>%
  filter(district_name_count > 1) %>%
  arrange(desc(n_schools))

# Duplicates of school name within a district
name_dupes_within_district <- schoolframe %>%
  filter(!is.na(District_Name), !is.na(BNAME)) %>%
  group_by(DCODE, District_Name, BNAME) %>%
  summarise(n_records = n(), .groups = "drop") %>%
  filter(n_records > 1) %>%
  arrange(desc(n_records))

name_dupes_within_district
```


## 5. Many-to-many matching: Maze.
### Examine by: 
### Prevalence:
### Solution: